---
title: mysql-index
date: 2023-08-29 10:36:41
categories:
- 数据库
- mysql
tags:

---

# mysql-索引

索引是帮助mysql**高效获取数据的数据结构（有序）**。这些数据结构以某种方式引用（指向）数据，这也就可以在这些数据结构上是实现高级查找算法，这种数据结构就是索引。

优势：提高数据检索的效率，降低数据的io成本，降低数据库排序的成本，降低cpu的消耗。

缺点：索引列需要空间，降低了更新表的速度。

## 索引结构

### B+树

相对于B树区别：所有的数据都会出现在叶子节点，叶子节点形成一个单向链表

Mysql索引结构对经典B+树进行了优化，在原B+树基础上，增加了一个指向相邻叶子节点的链表指针，形成了带有顺序指针的B+树，提高区间访问的效率。

### Hash

用的链地址法处理冲突

特点：

​	hash索引只能用于对等比较（=，in），不支持范围查询（between，>，<，...）

​	无法利用索引完成排序操作

​	查询效率高，通常只需要以此检索就可以了，效率通常高于b+树

mysql中，支持hash索引的是Memory引擎，而InnoDB中具有自适应hash功能，hash索引是存储引擎根据B+树索引在指定条件下自动构建的。

## 索引分类

| 分类     | 含义                                                 | 特点                     | 关键字   |
| -------- | ---------------------------------------------------- | ------------------------ | -------- |
| 主键索引 | 针对表中主键创建的索引                               | 默认自动创建，只能有一个 | primary  |
| 唯一索引 | 避免同一个表中某数据列中的值重复                     | 可以有多个               | unique   |
| 常规索引 | 快速定位特定数据                                     | 可以有多个               |          |
| 全文索引 | 全文索引查找的是文本中的关键词，而不是比较索引中的值 | 可以有多个               | fulltext |

在innodb中，根据索引的存储形式，又可以分为以下两种：

| 分类                        | 含义                                                         | 特点                 |
| --------------------------- | ------------------------------------------------------------ | -------------------- |
| 聚集索引（clustered index） | 将数据存储和索引放到了一块，索引结构中的叶子节点保持了行数据 | 必须有，而且只有一个 |
| 二级索引（secondary index） | 将数据和索引分开存储，索引结构的叶子节点关联的是对应的主键   | 可以存在多个         |

聚集索引选取规则：

​	以下顺序：主键索引->唯一索引->自动生成一个rowid作为隐藏的聚集索引。

## 索引语法

创建索引

```mysql
create [unique|fulltext] index index_name on table_name (index_col_name,...);
# 前缀索引 n表示前多少个位置
cerate index idx_xxxx on table_name(column(n))
可以根据索引的选择性来决定，而选择性是指不重复的索引值（基数）和数据表的记录总数的比值，索引选择性越高则查询效率越高，唯一索引的选择性是1，这是最好的索引选择性，性能也是最好的
select count(distinct xxx)/count(*) from xxx;
select count(distinct substring(xxx,1,n))/count(*) from xxx;
```

查看索引

```mysql
show index from table_name;
```

删除索引

```mysql
drop index index_name on table_name;
```

## sql性能分析

sql执行频率：mysql客户端连接成功后，通过show [session|global] status命令可以提供服务器状态信息。可以查看当前数据库的insert，update，delete，select的访问频次

```mysql
show global status like 'Com____';
```

慢查询日志



profile详情

```mysql
# 查看每一条sql的耗时基本情况
show profiles;

# 查看指定query_id的sql语句每个阶段的耗时情况
show profile for query query_id;

# 查看指定query_id的sql语句cpu的使用情况
show profile cpu for query_id;
```



explain执行计划

explain或者desc命令获取mysql如果执行select语句的信息，包括在select语句执行过程中表如果连接和连接的顺序

```mysql
# 直接在select语句之前加上关键字explain/desc
explain ...
```



## 索引使用规则

1.争对数据量较大，查询比较频繁的表建立索引

2.针对常作为where，order by，group by操作的字段建立索引

3.尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高

4.如果是字符串类型，字符较长，针对字段的特点，建立前缀索引

5.尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高效率

6.控制索引的数量

7.如果索引列不能存储null值，请在创建表时使用not null约束它，当优化器知道每列是否包含null值时，它可以更好的确定哪个索引更有效的用于查询

最左前缀法制

如果索引了多列（联合索引），要遵守最左前缀法制，查询从索引的最左列开始（放的位置没有影响，只要存在），并且不跳过索引中的列。

如果跳过某一列，索引将部分失效（**后面的字段索引失效**）

**联合索引**的最左匹配原则：在遇到范围查询（如>,<）的时候，就会停止匹配，也就是范围查询的字段可以用到联合索引，但是在范围查询字段后面的字段无法用到联合索引。注意，对于>=,<=,between,like前缀匹配的范围查询，并不会停止匹配

范围查询

联合索引中，出现范围查询（>，<），范围查询右侧的列索引失效

索引列运算

不要在索引列上进行运算操作，索引将失效

字符串不加引号

字符串类型字段使用时，不加引号，索引将失效

模糊查询

如果仅仅是尾部模糊匹配，索引不会失效，如果是头部模糊匹配，索引失效。如果把查询列换为索引与之对应的列，头部模糊匹配就会解决，也就是使用覆盖索引

or连接的条件

用or分隔开的条件，如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到

数据分布影响

如果mysql评估使用索引比全表更慢，则不会使用索引



sql提示

use index：使用某索引

ignore index：忽略某索引

force index：强制执行某索引



覆盖索引

尽量使用覆盖索引（查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到），减少select *

using index condition：查找使用了索引，但是需要回表查询数据

using where，using index：查找使用了索引，但是需要的数据都在索引列中能够找到，所以不需要回表查询数据



